# RBACæƒé™ç³»ç»Ÿéƒ¨ç½²æŒ‡å—

## ğŸ“‹ éƒ¨ç½²æ¦‚è¿°

æœ¬æŒ‡å—ä»‹ç»å¦‚ä½•éƒ¨ç½²å·²å®Œæˆçš„RBACæƒé™ç³»ç»Ÿä¸šåŠ¡æœåŠ¡å±‚ï¼Œä»¥åŠåç»­APIæ¥å£å±‚çš„éƒ¨ç½²æ–¹æ¡ˆã€‚

## ğŸ”§ ç¯å¢ƒè¦æ±‚

### ç³»ç»Ÿè¦æ±‚
- **æ“ä½œç³»ç»Ÿ**: Linux/Windows/macOS
- **Pythonç‰ˆæœ¬**: 3.8+
- **å†…å­˜**: æœ€å°‘512MBï¼Œæ¨è2GB+
- **å­˜å‚¨**: æœ€å°‘1GBå¯ç”¨ç©ºé—´

### ä¾èµ–è½¯ä»¶
```bash
# Pythonä¾èµ–
pip install sqlalchemy
pip install sqlite3  # æˆ– postgresql/mysqlé©±åŠ¨
pip install bcrypt
pip install PyJWT
pip install pytest  # æµ‹è¯•æ¡†æ¶

# APIæ¥å£å±‚ä¾èµ–ï¼ˆå¾…å¼€å‘æ—¶å®‰è£…ï¼‰
pip install flask
pip install flask-restx
pip install flask-cors
pip install gunicorn  # ç”Ÿäº§ç¯å¢ƒWSGIæœåŠ¡å™¨
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. é¡¹ç›®ç»“æ„å‡†å¤‡
```bash
# å…‹éš†æˆ–ä¸‹è½½é¡¹ç›®ä»£ç 
git clone <repository-url>
cd rbac-system

# é¡¹ç›®ç»“æ„
rbac-system/
â”œâ”€â”€ dao/                    # æ•°æ®è®¿é—®å±‚
â”œâ”€â”€ models/                 # æ¨¡å‹å±‚
â”œâ”€â”€ services/               # ä¸šåŠ¡æœåŠ¡å±‚
â”œâ”€â”€ utils/                  # å·¥å…·ç±»
â”œâ”€â”€ config/                 # é…ç½®æ–‡ä»¶
â”œâ”€â”€ tests/                  # æµ‹è¯•æ–‡ä»¶
â”œâ”€â”€ requirements.txt        # ä¾èµ–åˆ—è¡¨
â””â”€â”€ README.md              # é¡¹ç›®è¯´æ˜
```

### 2. å®‰è£…ä¾èµ–
```bash
# åˆ›å»ºè™šæ‹Ÿç¯å¢ƒ
python -m venv venv

# æ¿€æ´»è™šæ‹Ÿç¯å¢ƒ
# Windows
venv\Scripts\activate
# Linux/macOS
source venv/bin/activate

# å®‰è£…ä¾èµ–
pip install -r requirements.txt
```

### 3. æ•°æ®åº“åˆå§‹åŒ–
```python
# åˆ›å»ºæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ init_database.py
from config.database import engine
from models.user import User
from models.role import Role
from models.permission import Permission
from models.user_role import UserRole
from models.role_permission import RolePermission

# åˆ›å»ºæ‰€æœ‰è¡¨
User.metadata.create_all(engine)
Role.metadata.create_all(engine)
Permission.metadata.create_all(engine)
UserRole.metadata.create_all(engine)
RolePermission.metadata.create_all(engine)

print("æ•°æ®åº“è¡¨åˆ›å»ºå®Œæˆ")
```

```bash
# è¿è¡Œåˆå§‹åŒ–è„šæœ¬
python init_database.py
```

### 4. åŸºç¡€åŠŸèƒ½æµ‹è¯•
```bash
# è¿è¡Œå•å…ƒæµ‹è¯•
python -m pytest tests/ -v

# è¿è¡ŒæœåŠ¡éªŒè¯
python development_tools/permission_auth_service_example.py
```

## ğŸ—ï¸ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²

### 1. æ•°æ®åº“é…ç½®

#### SQLiteé…ç½®ï¼ˆå¼€å‘/å°å‹éƒ¨ç½²ï¼‰
```python
# config/database.py
DATABASE_URL = "sqlite:///rbac_system.db"
```

#### PostgreSQLé…ç½®ï¼ˆæ¨èç”Ÿäº§ç¯å¢ƒï¼‰
```python
# config/database.py
DATABASE_URL = "postgresql://username:password@localhost:5432/rbac_system"

# å®‰è£…PostgreSQLé©±åŠ¨
pip install psycopg2-binary
```

#### MySQLé…ç½®
```python
# config/database.py
DATABASE_URL = "mysql+pymysql://username:password@localhost:3306/rbac_system"

# å®‰è£…MySQLé©±åŠ¨
pip install PyMySQL
```

### 2. ç¯å¢ƒå˜é‡é…ç½®
```bash
# .env æ–‡ä»¶
DATABASE_URL=postgresql://username:password@localhost:5432/rbac_system
JWT_SECRET_KEY=your-super-secret-jwt-key-change-in-production
JWT_ALGORITHM=HS256
JWT_ACCESS_TOKEN_EXPIRE_MINUTES=15
JWT_REFRESH_TOKEN_EXPIRE_DAYS=7
BCRYPT_ROUNDS=12
LOG_LEVEL=INFO
```

### 3. æ—¥å¿—é…ç½®
```python
# config/logging.py
import logging
import os

LOG_LEVEL = os.getenv('LOG_LEVEL', 'INFO')

logging.basicConfig(
    level=getattr(logging, LOG_LEVEL),
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    handlers=[
        logging.FileHandler('logs/rbac_system.log'),
        logging.StreamHandler()
    ]
)
```

### 4. APIæœåŠ¡éƒ¨ç½²ï¼ˆå¾…å¼€å‘å®Œæˆåï¼‰

#### å¼€å‘ç¯å¢ƒ
```bash
# ä½¿ç”¨Flaskå¼€å‘æœåŠ¡å™¨
python app.py
# æˆ–
flask run --host=0.0.0.0 --port=5000
```

#### ç”Ÿäº§ç¯å¢ƒ
```bash
# ä½¿ç”¨Gunicorn WSGIæœåŠ¡å™¨
gunicorn -w 4 -b 0.0.0.0:5000 app:app

# æˆ–ä½¿ç”¨é…ç½®æ–‡ä»¶
gunicorn -c gunicorn.conf.py app:app
```

#### Gunicorné…ç½®æ–‡ä»¶
```python
# gunicorn.conf.py
bind = "0.0.0.0:5000"
workers = 4
worker_class = "sync"
worker_connections = 1000
max_requests = 1000
max_requests_jitter = 100
timeout = 30
keepalive = 2
preload_app = True
```

## ğŸ³ Dockeréƒ¨ç½²

### 1. Dockerfile
```dockerfile
FROM python:3.9-slim

WORKDIR /app

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# å¤åˆ¶ä¾èµ–æ–‡ä»¶
COPY requirements.txt .

# å®‰è£…Pythonä¾èµ–
RUN pip install --no-cache-dir -r requirements.txt

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY . .

# åˆ›å»ºæ—¥å¿—ç›®å½•
RUN mkdir -p logs

# æš´éœ²ç«¯å£
EXPOSE 5000

# å¯åŠ¨å‘½ä»¤
CMD ["gunicorn", "-c", "gunicorn.conf.py", "app:app"]
```

### 2. docker-compose.yml
```yaml
version: '3.8'

services:
  rbac-api:
    build: .
    ports:
      - "5000:5000"
    environment:
      - DATABASE_URL=postgresql://rbac_user:rbac_pass@db:5432/rbac_system
      - JWT_SECRET_KEY=your-super-secret-jwt-key
    depends_on:
      - db
    volumes:
      - ./logs:/app/logs

  db:
    image: postgres:13
    environment:
      - POSTGRES_DB=rbac_system
      - POSTGRES_USER=rbac_user
      - POSTGRES_PASSWORD=rbac_pass
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  redis:
    image: redis:6-alpine
    ports:
      - "6379:6379"

volumes:
  postgres_data:
```

### 3. éƒ¨ç½²å‘½ä»¤
```bash
# æ„å»ºå’Œå¯åŠ¨æœåŠ¡
docker-compose up -d

# æŸ¥çœ‹æ—¥å¿—
docker-compose logs -f rbac-api

# åœæ­¢æœåŠ¡
docker-compose down
```

## ğŸ”’ å®‰å…¨é…ç½®

### 1. JWTå¯†é’¥ç®¡ç†
```bash
# ç”Ÿæˆå¼ºå¯†é’¥
python -c "import secrets; print(secrets.token_urlsafe(32))"

# ç¯å¢ƒå˜é‡è®¾ç½®
export JWT_SECRET_KEY="your-generated-secret-key"
```

### 2. æ•°æ®åº“å®‰å…¨
```sql
-- åˆ›å»ºä¸“ç”¨æ•°æ®åº“ç”¨æˆ·
CREATE USER rbac_user WITH PASSWORD 'strong_password';
GRANT CONNECT ON DATABASE rbac_system TO rbac_user;
GRANT USAGE ON SCHEMA public TO rbac_user;
GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA public TO rbac_user;
```

### 3. é˜²ç«å¢™é…ç½®
```bash
# åªå…è®¸å¿…è¦ç«¯å£
ufw allow 22    # SSH
ufw allow 80    # HTTP
ufw allow 443   # HTTPS
ufw allow 5000  # APIæœåŠ¡ï¼ˆå¯é€‰ï¼Œé€šè¿‡åå‘ä»£ç†ï¼‰
ufw enable
```

## ğŸ“Š ç›‘æ§å’Œç»´æŠ¤

### 1. å¥åº·æ£€æŸ¥
```python
# health_check.py
from services.user_service import UserService

def health_check():
    try:
        with UserService() as service:
            # ç®€å•çš„æ•°æ®åº“è¿æ¥æµ‹è¯•
            service.count_all()
        return {"status": "healthy", "database": "connected"}
    except Exception as e:
        return {"status": "unhealthy", "error": str(e)}
```

### 2. æ—¥å¿—ç›‘æ§
```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f logs/rbac_system.log

# æŸ¥çœ‹é”™è¯¯æ—¥å¿—
grep ERROR logs/rbac_system.log

# æ—¥å¿—è½®è½¬é…ç½®
logrotate -d /etc/logrotate.d/rbac_system
```

### 3. æ€§èƒ½ç›‘æ§
```python
# ç›‘æ§å…³é”®æŒ‡æ ‡
- APIå“åº”æ—¶é—´
- æ•°æ®åº“æŸ¥è¯¢æ€§èƒ½
- å†…å­˜ä½¿ç”¨æƒ…å†µ
- æƒé™æ£€æŸ¥ç¼“å­˜å‘½ä¸­ç‡
- ç”¨æˆ·ç™»å½•æˆåŠŸç‡
```

## ğŸ”„ å¤‡ä»½å’Œæ¢å¤

### 1. æ•°æ®åº“å¤‡ä»½
```bash
# PostgreSQLå¤‡ä»½
pg_dump -h localhost -U rbac_user rbac_system > backup_$(date +%Y%m%d).sql

# æ¢å¤
psql -h localhost -U rbac_user rbac_system < backup_20250721.sql
```

### 2. è‡ªåŠ¨å¤‡ä»½è„šæœ¬
```bash
#!/bin/bash
# backup.sh
BACKUP_DIR="/var/backups/rbac_system"
DATE=$(date +%Y%m%d_%H%M%S)

mkdir -p $BACKUP_DIR

# æ•°æ®åº“å¤‡ä»½
pg_dump -h localhost -U rbac_user rbac_system > $BACKUP_DIR/db_backup_$DATE.sql

# ä¿ç•™æœ€è¿‘7å¤©çš„å¤‡ä»½
find $BACKUP_DIR -name "db_backup_*.sql" -mtime +7 -delete

echo "å¤‡ä»½å®Œæˆ: $BACKUP_DIR/db_backup_$DATE.sql"
```

## ğŸ“ˆ æ‰©å±•éƒ¨ç½²

### 1. è´Ÿè½½å‡è¡¡
```nginx
# nginx.conf
upstream rbac_backend {
    server 127.0.0.1:5000;
    server 127.0.0.1:5001;
    server 127.0.0.1:5002;
}

server {
    listen 80;
    server_name api.rbac-system.com;

    location / {
        proxy_pass http://rbac_backend;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}
```

### 2. ç¼“å­˜é…ç½®
```python
# ä½¿ç”¨Redisç¼“å­˜
import redis

redis_client = redis.Redis(host='localhost', port=6379, db=0)

# æƒé™æ£€æŸ¥ç¼“å­˜
def cache_permission_result(user_id, permission_code, result):
    key = f"perm:{user_id}:{permission_code}"
    redis_client.setex(key, 900, str(result))  # 15åˆ†é’Ÿè¿‡æœŸ
```

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼š1.0.0  
**æ›´æ–°æ—¶é—´**ï¼š2025-07-21  
**é€‚ç”¨ç‰ˆæœ¬**ï¼šRBACæƒé™ç³»ç»Ÿ v1.0.0
