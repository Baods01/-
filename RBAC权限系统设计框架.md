# RBAC权限系统数据库设计与实现框架

## 项目概述
设计并实现一套基于角色的访问控制（RBAC）权限系统数据库，包含完整的测试数据生成和性能测试功能。

## 任务目标
构建一个高效、安全、可扩展的RBAC权限管理系统，支持海量数据存储和快速权限验证。

## 核心组件
- **用户管理**：用户基本信息、认证信息
- **角色管理**：角色定义、角色层级
- **权限管理**：权限定义、资源管理
- **关联关系**：用户-角色、角色-权限映射
- **安全机制**：密码加密、操作审计
- **测试系统**：数据生成、性能测试

## 任务步骤详解

### 第一阶段：数据库设计
**目标**：设计符合RBAC原则的数据库结构
- [ ] 分析RBAC核心要素（用户、角色、权限）
- [ ] 设计主要实体表结构
- [ ] 设计关联关系表
- [ ] 输出完整SQL建表语句
- [ ] 添加必要的索引和约束

**预期产出**：
- 数据库设计文档
- SQL建表脚本
- ER图（可选）

### 第二阶段：数据库优化
**目标**：简化设计，提高效率
- [ ] 识别并删除冗余字段
- [ ] 合并功能相似的表
- [ ] 优化数据类型选择
- [ ] 精简表结构

**优化原则**：
- 遵循数据库范式
- 平衡存储空间与查询效率
- 保持设计简洁明了

### 第三阶段：安全与审计功能
**目标**：增强系统安全性和可追溯性
- [ ] 实现密码安全存储（bcrypt加盐加密）
- [ ] 设计操作日志表结构
- [ ] 添加用户会话管理
- [ ] 实现权限验证机制

**安全要求**：
- 禁用MD5/SHA1等弱加密算法
- 实现完整的操作审计
- 支持会话管理和超时控制

### 第四阶段：测试数据生成
**目标**：生成海量测试数据进行系统验证
- [ ] 设计Python数据生成脚本
- [ ] 生成真实感测试数据
- [ ] 批量数据插入优化
- [ ] 数据一致性验证

**数据规模**：
- 用户：10万+ 记录
- 角色：1000+ 记录
- 权限：5000+ 记录
- 关联关系：百万级记录

### 第五阶段：性能测试
**目标**：验证系统性能和优化瓶颈
- [ ] 权限查询性能测试
- [ ] 用户认证性能测试
- [ ] 批量操作性能测试
- [ ] 并发访问测试
- [ ] 性能优化建议

## 技术栈
- **数据库**：MySQL/PostgreSQL
- **编程语言**：Python 3.8+
- **加密库**：bcrypt
- **数据库连接**：SQLAlchemy/pymysql
- **测试框架**：pytest
- **性能测试**：自定义脚本

## 预期交付物
1. 数据库设计文档
2. SQL建表脚本
3. Python数据生成脚本
4. 性能测试脚本
5. 测试报告和优化建议

## 项目时间线
- 第一阶段：数据库设计（预计1-2天）
- 第二阶段：结构优化（预计0.5天）
- 第三阶段：安全功能（预计1天）
- 第四阶段：数据生成（预计1天）
- 第五阶段：性能测试（预计1天）

## 成功标准
- [ ] 数据库设计符合RBAC标准
- [ ] 支持百万级数据存储
- [ ] 权限查询响应时间 < 100ms
- [ ] 密码安全存储（bcrypt）
- [ ] 完整的操作审计日志
- [ ] 通过所有性能测试

## 详细提示词执行方案

### 🔧 第一阶段提示词：基础RBAC数据库设计

**执行提示词：**
```
任务：设计标准RBAC权限系统数据库

核心要求：
1. 创建用户表(users)：用户ID、用户名、邮箱、状态、创建时间、更新时间
2. 创建角色表(roles)：角色ID、角色名、角色代码、状态、创建时间、更新时间
3. 创建权限表(permissions)：权限ID、权限名、权限代码、资源类型、操作类型、创建时间
4. 创建用户角色关联表(user_roles)：用户ID、角色ID、分配时间、分配人、状态
5. 创建角色权限关联表(role_permissions)：角色ID、权限ID、授权时间、授权人、状态

技术规范：
- 数据库：MySQL 8.0+
- 字符集：utf8mb4
- 主键：使用AUTO_INCREMENT
- 外键：添加适当的外键约束
- 索引：为查询频繁的字段添加索引
- 审计：所有表包含created_at、updated_at字段
- 状态：使用TINYINT表示启用/禁用状态

输出文件：sql/01_basic_rbac_schema.sql
同时创建：docs/01_database_design.md（设计说明文档）
```

---

### 🛡️ 第二阶段提示词：数据库优化与安全增强

**执行提示词：**
```
任务：优化数据库结构并添加安全功能

优化任务：
1. 分析第一阶段的表结构，识别冗余字段并删除
2. 检查是否有功能重复的表，考虑合并
3. 优化数据类型选择（VARCHAR长度、INT类型等）
4. 精简索引设计，删除不必要的索引
5. 添加必要的唯一约束

安全增强任务：
1. 用户表添加password_hash字段（VARCHAR(255)）
2. 创建操作日志表(audit_logs)：
   - 日志ID、用户ID、操作类型、操作对象、操作时间
   - IP地址、用户代理、操作结果、详细信息
3. 创建用户会话表(user_sessions)：
   - 会话ID、用户ID、会话令牌、创建时间、过期时间、IP地址
4. 开发Python密码工具类：
   - 使用bcrypt进行密码加密
   - 提供密码验证功能
   - 禁用MD5/SHA1等弱算法

技术要求：
- 密码加密：bcrypt，salt rounds >= 12
- 会话管理：支持超时控制，默认24小时
- 日志记录：记录所有敏感操作
- 数据库连接：使用连接池，支持事务

输出文件：
- sql/02_optimized_schema.sql（优化后的数据库结构）
- sql/03_security_features.sql（安全功能表结构）
- utils/password_utils.py（密码加密工具类）
- utils/db_utils.py（数据库连接工具类）
- docs/02_optimization_report.md（优化报告）
```

---

### 🧪 第三阶段提示词：测试数据生成与性能测试

**执行提示词：**
```
任务：开发完整的测试数据生成和性能测试系统

数据生成规模：
1. 用户数据：100,000条记录
   - 真实感用户名、邮箱（使用faker库）
   - 加密密码（统一使用"password123"加密后存储）
   - 随机状态分布（90%启用，10%禁用）
2. 角色数据：1,000条记录
   - 角色名称：管理员、编辑、查看者等分层角色
   - 角色代码：admin、editor、viewer等
3. 权限数据：5,000条记录
   - 涵盖用户管理、内容管理、系统设置等模块
   - 包含增删改查等基本操作
4. 关联关系：
   - 用户-角色：平均每用户3-5个角色，总计300,000条
   - 角色-权限：平均每角色10-20个权限，总计15,000条
5. 操作日志：1,000,000条历史记录

性能测试场景：
1. 用户认证测试：
   - 单次登录响应时间
   - 并发登录测试（100/500/1000并发）
2. 权限查询测试：
   - 单用户权限查询（< 50ms）
   - 批量用户权限查询
   - 复杂权限验证（多角色用户）
3. 数据操作测试：
   - 用户创建/更新/删除性能
   - 角色权限分配性能
   - 批量操作性能
4. 系统压力测试：
   - 数据库连接池测试
   - 长时间运行稳定性测试

技术实现：
- 数据生成：使用faker + 批量插入优化
- 性能测试：多线程并发测试
- 进度显示：实时显示生成/测试进度
- 错误处理：完善的异常处理和重试机制
- 报告生成：详细的HTML/PDF测试报告

输出文件：
- scripts/data_generator.py（数据生成器）
- scripts/performance_test.py（性能测试脚本）
- scripts/report_generator.py（报告生成器）
- config/test_config.py（测试配置）
- main.py（主执行入口）
- requirements.txt（依赖包列表）
```

---

## 任务执行检查清单

### ✅ 第一阶段检查项
- [ ] 创建sql目录和01_basic_rbac_schema.sql文件
- [ ] 5张核心表结构设计完成（users, roles, permissions, user_roles, role_permissions）
- [ ] 所有表包含主键、外键约束
- [ ] 添加必要的索引（用户名、邮箱、角色代码、权限代码等）
- [ ] 包含审计字段（created_at, updated_at）
- [ ] 创建数据库设计文档
- [ ] SQL语句可以成功执行

### ✅ 第二阶段检查项
- [ ] 数据库结构优化完成，删除冗余字段
- [ ] 安全功能表创建完成（audit_logs, user_sessions）
- [ ] 密码工具类实现bcrypt加密
- [ ] 数据库连接工具类支持连接池
- [ ] 所有Python工具类包含完整的错误处理
- [ ] 创建优化报告和安全设计文档
- [ ] 单元测试验证工具类功能

### ✅ 第三阶段检查项
- [ ] 数据生成脚本能生成指定规模的测试数据
- [ ] 性能测试脚本涵盖所有测试场景
- [ ] 测试报告生成器输出详细报告
- [ ] 主执行脚本整合所有功能
- [ ] requirements.txt包含所有依赖
- [ ] 所有脚本包含进度显示和错误处理
- [ ] 性能测试达到预期指标

---

## 完整项目文件结构

```
sql_database/
├── sql/                          # SQL脚本目录
│   ├── 01_basic_rbac_schema.sql     # 基础RBAC建表语句
│   ├── 02_optimized_schema.sql      # 优化后的数据库结构
│   └── 03_security_features.sql     # 安全功能表结构
├── utils/                        # 工具类目录
│   ├── __init__.py
│   ├── password_utils.py            # 密码加密工具
│   └── db_utils.py                  # 数据库操作工具
├── scripts/                      # 脚本目录
│   ├── __init__.py
│   ├── data_generator.py            # 数据生成脚本
│   ├── performance_test.py          # 性能测试脚本
│   └── report_generator.py          # 报告生成器
├── config/                       # 配置文件目录
│   ├── __init__.py
│   ├── test_config.py               # 测试配置
│   └── database_config.py           # 数据库配置
├── tests/                        # 测试目录
│   ├── __init__.py
│   └── test_rbac_system.py          # 单元测试
├── docs/                         # 文档目录
│   ├── 01_database_design.md        # 数据库设计文档
│   ├── 01_er_diagram.md             # ER图说明
│   ├── 02_optimization_report.md    # 优化报告
│   └── 03_security_design.md        # 安全设计文档
├── reports/                      # 报告输出目录
├── logs/                         # 日志目录
├── main.py                       # 主执行入口
├── requirements.txt              # Python依赖
└── RBAC权限系统设计框架.md        # 项目框架文档
```

---

*注：本框架将根据实际开发过程进行调整和完善*
