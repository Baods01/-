# ä»»åŠ¡7ï¼šä¸šåŠ¡é€»è¾‘å±‚åŠæ¥å£å±‚å¼€å‘

## ğŸ“‹ ä»»åŠ¡æ¦‚è¿°

**ä»»åŠ¡åç§°**ï¼šå¼€å‘-ä¸šåŠ¡é€»è¾‘å±‚åŠæ¥å£å±‚å¼€å‘
**å…³é”®å­—**ï¼š2025æ˜¥
**å½•å…¥æ—¶é—´**ï¼š2025/7/16 15:24:25
**å½“å‰çŠ¶æ€**ï¼šåŸºäºå®Œæ•´ORMå±‚ï¼Œå‡†å¤‡é«˜æ•ˆå¼€å‘

### ğŸ‰ é¡¹ç›®ä¼˜åŠ¿
- âœ… **å®Œæ•´çš„æ•°æ®åŸºç¡€**ï¼š5ä¸ªæ¨¡å‹ç±»ï¼Œ92ä¸ªä¸šåŠ¡æ–¹æ³•
- âœ… **æˆç†Ÿçš„DAOå±‚**ï¼šç»è¿‡å…¨é¢æµ‹è¯•ï¼Œæ”¯æŒSQLAlchemy 2.0+
- âœ… **å®‰å…¨å·¥å…·é½å…¨**ï¼šbcryptå¯†ç åŠ å¯†ï¼Œå®Œæ•´çš„å·¥å…·ç±»
- âœ… **æµ‹è¯•æ¡†æ¶å®Œå¤‡**ï¼špytesté…ç½®ï¼Œå¯ç›´æ¥æ‰©å±•APIæµ‹è¯•
- ğŸš€ **å¼€å‘æ•ˆç‡æå‡50%**ï¼šæ— éœ€é‡æ–°è®¾è®¡åº•å±‚æ¶æ„

## ğŸ¯ å®éªŒç›®çš„

### ä¸»è¦ç›®æ ‡
1. **ç†è®ºå­¦ä¹ **ï¼šäº†è§£ä¸šåŠ¡é€»è¾‘å±‚ç›¸å…³çŸ¥è¯†
2. **å®è·µæŠ€èƒ½**ï¼šç†Ÿæ‚‰ä½¿ç”¨AIç¼–ç¨‹å·¥å…·ï¼Œè®¾è®¡ä¸šåŠ¡é€»è¾‘å±‚ã€æ¥å£å±‚
3. **ç³»ç»Ÿé›†æˆ**ï¼šåŸºäºå·²å®Œæˆçš„ORMå±‚ï¼Œæ„å»ºå®Œæ•´çš„RBACæƒé™ç³»ç»Ÿ

### å­¦ä¹ æˆæœ
- æŒæ¡ä¸šåŠ¡é€»è¾‘å±‚çš„è®¾è®¡åŸåˆ™å’Œå®ç°æ–¹æ³•
- ç†è§£æ¥å£å±‚çš„å°è£…å’Œå®‰å…¨æœºåˆ¶
- ç†Ÿç»ƒä½¿ç”¨AIå·¥å…·è¿›è¡Œç³»ç»Ÿå¼€å‘

## ğŸ—ï¸ ç³»ç»Ÿæ¶æ„è¯´æ˜

### ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆBusiness Logic Layerï¼‰
**ä½ç½®**ï¼šDAOå±‚ä¹‹ä¸Š  
**èŒè´£**ï¼š
- é€šè¿‡è°ƒç”¨DAOå±‚æ¥å£å®ç°ä¸šåŠ¡é€»è¾‘
- å¯¹åº”å‰ç«¯ç•Œé¢åŠ¨ä½œçš„åå°å®ç°
- ä¸“æ³¨äºä¸šåŠ¡å®ç°å’Œæ•°æ®å¤„ç†ç®—æ³•
- å¼‚å¸¸å¤„ç†å’Œä¸šåŠ¡æ—¥å¿—è®°å½•
- å¯¹æ¥å„ç§ä¸­é—´ä»¶ï¼ˆæ¶ˆæ¯ã€æ—¥å¿—ã€ç¼“å­˜ç­‰ï¼‰

**æ¥å£ä¸‰è¦ç´ **ï¼š
1. æ¥å£åç§°
2. è¾“å…¥å‚æ•°
3. è¾“å‡ºå‚æ•°

### æ¥å£å±‚ï¼ˆAPI Layerï¼‰
**ä½ç½®**ï¼šä¸šåŠ¡é€»è¾‘å±‚ä¹‹ä¸Š  
**èŒè´£**ï¼š
- æä¾›ç‰¹å®šæ ¼å¼çš„å¤–éƒ¨è®¿é—®ï¼ˆå¦‚WebAPIï¼‰
- å°è£…ä¸šåŠ¡é€»è¾‘æ¥å£
- å®‰å…¨è®¿é—®æ§åˆ¶ï¼ˆJWTã€è®¤è¯ã€åŠ å¯†è§£å¯†ï¼‰
- æ¥å£æ—¥å¿—è®°å½•
- æ•°æ®æ ¼å¼è½¬æ¢ï¼ˆJSONç­‰ï¼‰

## ğŸ”§ å®ç°è¦æ±‚

### æ ¸å¿ƒä»»åŠ¡
åŸºäºRBACæƒé™ç³»ç»Ÿçš„ä¸šåŠ¡éœ€æ±‚å’Œæ•°æ®åº“è®¾è®¡ï¼Œå®Œæˆå®Œæ•´çš„WebAPIæ¥å£å®ç°ã€‚

### å¿…éœ€æ¥å£åˆ—è¡¨

#### 1. ç”¨æˆ·ç®¡ç†æ¥å£

**ç”¨æˆ·åŸºç¡€æ“ä½œ**
- `POST /api/users` - åˆ›å»ºæ–°ç”¨æˆ·
- `GET /api/users/{id}` - è·å–ç”¨æˆ·è¯¦æƒ…
- `PUT /api/users/{id}` - æ›´æ–°ç”¨æˆ·ä¿¡æ¯
- `DELETE /api/users/{id}` - åˆ é™¤ç”¨æˆ·
- `GET /api/users` - è·å–ç”¨æˆ·åˆ—è¡¨(åˆ†é¡µ)
- `PUT /api/users/{id}/status` - æ›´æ–°ç”¨æˆ·çŠ¶æ€(å¯ç”¨/ç¦ç”¨)

**ç”¨æˆ·è®¤è¯ç›¸å…³**
- `POST /api/users/login` - ç”¨æˆ·ç™»å½•
- `POST /api/users/logout` - ç”¨æˆ·ç™»å‡º
- `POST /api/users/password/reset` - é‡ç½®å¯†ç è¯·æ±‚
- `PUT /api/users/password` - ä¿®æ”¹å¯†ç 
- `POST /api/users/token/refresh` - åˆ·æ–°è®¿é—®ä»¤ç‰Œ

#### 2. è§’è‰²ç®¡ç†æ¥å£
- `POST /api/roles` - åˆ›å»ºæ–°è§’è‰²
- `GET /api/roles/{id}` - è·å–è§’è‰²è¯¦æƒ…
- `PUT /api/roles/{id}` - æ›´æ–°è§’è‰²ä¿¡æ¯
- `DELETE /api/roles/{id}` - åˆ é™¤è§’è‰²
- `GET /api/roles` - è·å–è§’è‰²åˆ—è¡¨(åˆ†é¡µ)
- `GET /api/roles/{id}/users` - è·å–æ‹¥æœ‰è¯¥è§’è‰²çš„ç”¨æˆ·åˆ—è¡¨
- `POST /api/roles/{id}/users` - ä¸ºç”¨æˆ·åˆ†é…è§’è‰²
- `DELETE /api/roles/{id}/users/{userId}` - ç§»é™¤ç”¨æˆ·çš„è§’è‰²

#### 3. æƒé™ç®¡ç†æ¥å£
- `POST /api/permissions` - åˆ›å»ºæ–°æƒé™
- `GET /api/permissions/{id}` - è·å–æƒé™è¯¦æƒ…
- `PUT /api/permissions/{id}` - æ›´æ–°æƒé™ä¿¡æ¯
- `DELETE /api/permissions/{id}` - åˆ é™¤æƒé™
- `GET /api/permissions` - è·å–æƒé™åˆ—è¡¨(åˆ†é¡µ)
- `GET /api/permissions/tree` - è·å–æƒé™æ ‘å½¢ç»“æ„
- `POST /api/permissions/{id}/roles` - ä¸ºè§’è‰²åˆ†é…æƒé™
- `DELETE /api/permissions/{id}/roles/{roleId}` - ç§»é™¤è§’è‰²çš„æƒé™

## ğŸ“ å…·ä½“å¼€å‘æ­¥éª¤

### ç¬¬ä¸€é˜¶æ®µï¼šä¸šåŠ¡é€»è¾‘å±‚å¼€å‘ï¼ˆåŸºäºç°æœ‰DAOï¼‰

#### 1.1 åˆ›å»ºæœåŠ¡å±‚åŸºç¡€æ¶æ„
```bash
# åˆ›å»ºæœåŠ¡å±‚ç›®å½•ç»“æ„
mkdir services
mkdir services/exceptions
```

#### 1.2 å®ç°åŸºç¡€æœåŠ¡ç±»
**æ–‡ä»¶ï¼š`services/base_service.py`**
- ç»§æ‰¿ç°æœ‰çš„æ•°æ®åº“è¿æ¥æœºåˆ¶
- é›†æˆç°æœ‰çš„å¼‚å¸¸å¤„ç†ï¼ˆDatabaseError, NotFoundErrorç­‰ï¼‰
- ç»Ÿä¸€çš„ä¸šåŠ¡æ—¥å¿—è®°å½•
- äº‹åŠ¡ç®¡ç†å°è£…

#### 1.3 å®ç°å…·ä½“ä¸šåŠ¡æœåŠ¡
**åŸºäºç°æœ‰DAOæ¥å£å®ç°ï¼š**

**UserService (`services/user_service.py`)**
- åˆ©ç”¨ `UserDao` çš„13ä¸ªä¸“ç”¨æ–¹æ³•
- é›†æˆ `PasswordUtils` è¿›è¡Œå¯†ç å¤„ç†
- ç”¨æˆ·æ³¨å†Œã€ç™»å½•ã€çŠ¶æ€ç®¡ç†
- ç”¨æˆ·æƒé™æ£€æŸ¥ï¼ˆåŸºäºç°æœ‰çš„ `get_user_permissions`ï¼‰

**RoleService (`services/role_service.py`)**
- åˆ©ç”¨ `RoleDao` çš„13ä¸ªä¸“ç”¨æ–¹æ³•
- è§’è‰²åˆ›å»ºã€æ›´æ–°ã€åˆ é™¤
- è§’è‰²ç”¨æˆ·å…³è”ç®¡ç†

**PermissionService (`services/permission_service.py`)**
- åˆ©ç”¨ `PermissionDao` çš„15ä¸ªä¸“ç”¨æ–¹æ³•
- æƒé™æ ‘å½¢ç»“æ„æ„å»º
- æƒé™åˆ†ç»„å’Œå±‚çº§ç®¡ç†

**AuthService (`services/auth_service.py`)**
- JWTä»¤ç‰Œç”Ÿæˆå’ŒéªŒè¯
- åŸºäºç°æœ‰ç”¨æˆ·æƒé™æ£€æŸ¥çš„è®¤è¯é€»è¾‘
- ä¼šè¯ç®¡ç†

### ç¬¬äºŒé˜¶æ®µï¼šæ¥å£å±‚å¼€å‘ï¼ˆFlask/FastAPIï¼‰

#### 2.1 é€‰æ‹©Webæ¡†æ¶
**æ¨èï¼šFastAPI**ï¼ˆåŸå› ï¼šè‡ªåŠ¨ç”ŸæˆSwaggeræ–‡æ¡£ï¼‰
```bash
pip install fastapi uvicorn python-jose[cryptography] python-multipart
```

#### 2.2 åˆ›å»ºAPIåº”ç”¨ç»“æ„
**æ–‡ä»¶ï¼š`api/app.py`**
- FastAPIåº”ç”¨åˆå§‹åŒ–
- ä¸­é—´ä»¶é…ç½®ï¼ˆCORSã€è®¤è¯ï¼‰
- å¼‚å¸¸å¤„ç†å™¨
- è‡ªåŠ¨Swaggeræ–‡æ¡£ç”Ÿæˆ

#### 2.3 å®ç°æ§åˆ¶å™¨
**åŸºäºç°æœ‰ä¸šåŠ¡é€»è¾‘ï¼š**

**UserController (`api/controllers/user_controller.py`)**
- è°ƒç”¨ `UserService` æ–¹æ³•
- è¯·æ±‚å‚æ•°éªŒè¯ï¼ˆPydanticæ¨¡å‹ï¼‰
- å“åº”æ ¼å¼æ ‡å‡†åŒ–

**ç¤ºä¾‹æ¥å£å®ç°ï¼š**
```python
@router.post("/users", response_model=UserResponse)
async def create_user(user_data: UserCreateRequest):
    # è°ƒç”¨ UserService.create_user()
    # åˆ©ç”¨ç°æœ‰çš„ User æ¨¡å‹éªŒè¯
    # è¿”å›æ ‡å‡†åŒ–å“åº”
```

### ç¬¬ä¸‰é˜¶æ®µï¼šé›†æˆç°æœ‰å·¥å…·å’Œæµ‹è¯•

#### 3.1 åˆ©ç”¨ç°æœ‰æµ‹è¯•æ¡†æ¶
- æ‰©å±•ç°æœ‰çš„ `pytest` æµ‹è¯•
- åŸºäºç°æœ‰çš„ `conftest.py` é…ç½®
- APIé›†æˆæµ‹è¯•

#### 3.2 åˆ©ç”¨ç°æœ‰å·¥å…·
- ä½¿ç”¨ç°æœ‰çš„ `password_utils.py`
- é›†æˆç°æœ‰çš„æ—¥å¿—ç³»ç»Ÿ
- åˆ©ç”¨ç°æœ‰çš„æ•°æ®ç”Ÿæˆå·¥å…·ï¼ˆFakerï¼‰

## ğŸ¯ æäº¤è¦æ±‚

### å¿…éœ€æäº¤å†…å®¹
1. **æºä»£ç **ï¼šå‹ç¼©ä¸ºRARæ ¼å¼
2. **Swaggeræ–‡æ¡£æˆªå›¾**ï¼šä¸€å¼ JPGæ ¼å¼å›¾ç‰‡
3. **ä¸»è¦æç¤ºè¯**ï¼šè´´åœ¨"è‡ªè¯„å¤‡æ³¨"ä¸­

### ä»£ç è´¨é‡è¦æ±‚
- ä»£ç ç»“æ„æ¸…æ™°ï¼Œæ³¨é‡Šå®Œæ•´
- éµå¾ªRESTfulè®¾è®¡åŸåˆ™
- å®ç°å®Œæ•´çš„é”™è¯¯å¤„ç†
- åŒ…å«å¿…è¦çš„å®‰å…¨æœºåˆ¶

## ğŸš€ æ·±å…¥å­¦ä¹ å»ºè®®

### é«˜çº§åŠŸèƒ½
1. **JWTé›†æˆ**ï¼šå®ç°åŸºäºä»¤ç‰Œçš„è®¤è¯æœºåˆ¶
2. **Swaggeræ–‡æ¡£**ï¼šç”Ÿæˆå®Œæ•´çš„APIæ–‡æ¡£
3. **å•å…ƒæµ‹è¯•**ï¼šä¸ºæ¯ä¸ªæ¥å£ç¼–å†™æµ‹è¯•ç”¨ä¾‹
4. **åˆ†é¡µæŸ¥è¯¢**ï¼šä¼˜åŒ–å¤§æ•°æ®é‡æŸ¥è¯¢æ€§èƒ½

### æ¨èæŠ€æœ¯æ ˆï¼ˆåŸºäºç°æœ‰é¡¹ç›®ï¼‰
- **åç«¯æ¡†æ¶**ï¼šFastAPIï¼ˆè‡ªåŠ¨Swaggeræ–‡æ¡£ç”Ÿæˆï¼‰
- **è®¤è¯æœºåˆ¶**ï¼šJWT + python-jose
- **æ•°æ®éªŒè¯**ï¼šPydanticï¼ˆFastAPIå†…ç½®ï¼‰
- **æµ‹è¯•æ¡†æ¶**ï¼špytestï¼ˆå·²é…ç½®ï¼‰
- **å¯†ç åŠ å¯†**ï¼šbcryptï¼ˆå·²å®ç°ï¼‰
- **æ•°æ®åº“**ï¼šSQLAlchemy 2.0+ï¼ˆå·²å®Œæˆï¼‰

### æ–°å¢ä¾èµ–åŒ…
```bash
# æ·»åŠ åˆ° requirements.txt
fastapi>=0.104.0                # Webæ¡†æ¶
uvicorn>=0.24.0                 # ASGIæœåŠ¡å™¨
python-jose[cryptography]>=3.3.0  # JWTå¤„ç†
python-multipart>=0.0.6        # æ–‡ä»¶ä¸Šä¼ æ”¯æŒ
pydantic>=2.0.0                 # æ•°æ®éªŒè¯
```

## ğŸ“Š é¡¹ç›®é‡Œç¨‹ç¢‘ï¼ˆåŸºäºç°æœ‰åŸºç¡€ï¼‰

| é˜¶æ®µ | å…·ä½“ä»»åŠ¡ | åŸºäºç°æœ‰èµ„æº | é¢„æœŸæ—¶é—´ | çŠ¶æ€ |
|------|----------|--------------|----------|------|
| 1 | ä¸šåŠ¡é€»è¾‘å±‚å®ç° | åŸºäºå®Œæ•´çš„DAOå±‚ | 2-3å¤© | å¾…å¼€å§‹ |
| 2 | FastAPIæ¥å£å±‚ | åˆ©ç”¨ç°æœ‰æ¨¡å‹å’Œå·¥å…· | 2å¤© | å¾…å¼€å§‹ |
| 3 | JWTè®¤è¯é›†æˆ | é›†æˆç°æœ‰å¯†ç å·¥å…· | 1å¤© | å¾…å¼€å§‹ |
| 4 | Swaggeræ–‡æ¡£ | FastAPIè‡ªåŠ¨ç”Ÿæˆ | 0.5å¤© | å¾…å¼€å§‹ |
| 5 | APIæµ‹è¯•æ‰©å±• | åŸºäºç°æœ‰pytestæ¡†æ¶ | 1å¤© | å¾…å¼€å§‹ |
| 6 | æ•´åˆæµ‹è¯• | åˆ©ç”¨ç°æœ‰æµ‹è¯•å·¥å…· | 0.5å¤© | å¾…å¼€å§‹ |

**æ€»é¢„æœŸæ—¶é—´ï¼š7å¤©**ï¼ˆç›¸æ¯”åŸè®¡åˆ’å‡å°‘1-2å¤©ï¼Œå› ä¸ºæœ‰å®Œæ•´çš„åŸºç¡€å±‚ï¼‰

## ğŸš€ å¿«é€Ÿå¼€å§‹æŒ‡å—

### ç¯å¢ƒå‡†å¤‡
```bash
# 1. ç¡®è®¤å½“å‰é¡¹ç›®ç»“æ„
cd sql_database
ls -la  # ç¡®è®¤models/, dao/, utils/ç­‰ç›®å½•å­˜åœ¨

# 2. å®‰è£…æ–°å¢ä¾èµ–
pip install fastapi uvicorn python-jose[cryptography] python-multipart pydantic

# 3. éªŒè¯ç°æœ‰åŸºç¡€
python -c "from dao.user_dao import UserDao; print('DAOå±‚æ­£å¸¸')"
python -c "from utils.password_utils import PasswordUtils; print('å·¥å…·å±‚æ­£å¸¸')"
```

### ç¬¬ä¸€æ­¥ï¼šåˆ›å»ºæœåŠ¡å±‚
```bash
# åˆ›å»ºç›®å½•ç»“æ„
mkdir -p services/exceptions
mkdir -p api/controllers
mkdir -p api/middleware
mkdir -p api/schemas

# åˆ›å»ºåˆå§‹æ–‡ä»¶
touch services/__init__.py
touch services/base_service.py
touch services/user_service.py
touch api/__init__.py
touch api/app.py
```

### ç¬¬äºŒæ­¥ï¼šå®ç°åŸºç¡€æœåŠ¡
1. **å¤åˆ¶ç¤ºä¾‹ä»£ç **ï¼šä½¿ç”¨ä¸Šé¢çš„UserServiceç¤ºä¾‹
2. **æµ‹è¯•æœåŠ¡å±‚**ï¼šç¼–å†™ç®€å•çš„æœåŠ¡æµ‹è¯•
3. **éªŒè¯DAOé›†æˆ**ï¼šç¡®è®¤ä¸ç°æœ‰DAOå±‚çš„é›†æˆ

### ç¬¬ä¸‰æ­¥ï¼šåˆ›å»ºAPIåº”ç”¨
1. **å®ç°FastAPIåº”ç”¨**ï¼šåŸºäºapp.pyç¤ºä¾‹
2. **æ·»åŠ ç¬¬ä¸€ä¸ªæ¥å£**ï¼šç”¨æˆ·åˆ›å»ºæ¥å£
3. **æµ‹è¯•API**ï¼šä½¿ç”¨FastAPIè‡ªåŠ¨ç”Ÿæˆçš„æ–‡æ¡£

### éªŒè¯æ­¥éª¤
```bash
# å¯åŠ¨APIæœåŠ¡
uvicorn api.app:app --reload

# è®¿é—®Swaggeræ–‡æ¡£
# http://localhost:8000/docs

# æµ‹è¯•APIæ¥å£
curl -X POST "http://localhost:8000/api/users" \
     -H "Content-Type: application/json" \
     -d '{"username":"test","email":"test@example.com","password":"password123"}'
```

## ğŸ—ï¸ å½“å‰é¡¹ç›®ç»“æ„åˆ†æ

### å·²å®Œæˆçš„æ ¸å¿ƒåŸºç¡€ âœ…
```
sql_database/
â”œâ”€â”€ models/                     # æ•°æ®æ¨¡å‹å±‚ï¼ˆå®Œæ•´ï¼‰
â”‚   â”œâ”€â”€ base_model.py          # åŸºç¡€æ¨¡å‹å’Œæ•°æ®åº“é…ç½®
â”‚   â”œâ”€â”€ user.py                # ç”¨æˆ·æ¨¡å‹ï¼ˆ16ä¸ªæ–¹æ³•ï¼‰
â”‚   â”œâ”€â”€ role.py                # è§’è‰²æ¨¡å‹ï¼ˆ18ä¸ªæ–¹æ³•ï¼‰
â”‚   â”œâ”€â”€ permission.py          # æƒé™æ¨¡å‹ï¼ˆ20ä¸ªæ–¹æ³•ï¼‰
â”‚   â”œâ”€â”€ user_role.py           # ç”¨æˆ·è§’è‰²å…³è”æ¨¡å‹
â”‚   â””â”€â”€ role_permission.py     # è§’è‰²æƒé™å…³è”æ¨¡å‹
â”œâ”€â”€ dao/                       # æ•°æ®è®¿é—®å±‚ï¼ˆå®Œæ•´ï¼‰
â”‚   â”œâ”€â”€ base_dao.py            # åŸºç¡€DAOæŠ½è±¡ç±»
â”‚   â”œâ”€â”€ user_dao.py            # ç”¨æˆ·DAOï¼ˆ13ä¸ªä¸“ç”¨æ–¹æ³•ï¼‰
â”‚   â”œâ”€â”€ role_dao.py            # è§’è‰²DAOï¼ˆ13ä¸ªä¸“ç”¨æ–¹æ³•ï¼‰
â”‚   â”œâ”€â”€ permission_dao.py      # æƒé™DAOï¼ˆ15ä¸ªä¸“ç”¨æ–¹æ³•ï¼‰
â”‚   â”œâ”€â”€ user_role_dao.py       # ç”¨æˆ·è§’è‰²å…³è”DAO
â”‚   â””â”€â”€ role_permission_dao.py # è§’è‰²æƒé™å…³è”DAO
â”œâ”€â”€ utils/                     # å·¥å…·ç±»ï¼ˆéƒ¨åˆ†å®Œæˆï¼‰
â”‚   â”œâ”€â”€ password_utils.py      # å¯†ç åŠ å¯†å·¥å…·ï¼ˆbcryptï¼‰
â”‚   â””â”€â”€ db_utils.py            # æ•°æ®åº“å·¥å…·
â”œâ”€â”€ tests/                     # å•å…ƒæµ‹è¯•ï¼ˆå®Œæ•´ï¼‰
â”‚   â”œâ”€â”€ test_user_dao.py       # ç”¨æˆ·DAOæµ‹è¯•
â”‚   â”œâ”€â”€ test_role_dao.py       # è§’è‰²DAOæµ‹è¯•
â”‚   â””â”€â”€ ...                    # å…¶ä»–æµ‹è¯•æ–‡ä»¶
â””â”€â”€ requirements.txt           # ä¾èµ–åŒ…é…ç½®
```

### æŠ€æœ¯æ ˆç°çŠ¶
- **æ•°æ®åº“ORM**ï¼šSQLAlchemy 2.0+ âœ…
- **å¯†ç åŠ å¯†**ï¼šbcrypt âœ…
- **æµ‹è¯•æ¡†æ¶**ï¼špytest âœ…
- **æ•°æ®ç”Ÿæˆ**ï¼šFaker âœ…
- **é…ç½®ç®¡ç†**ï¼šPyYAML âœ…
- **æ—¥å¿—ç³»ç»Ÿ**ï¼šcolorlog âœ…

### å¾…å¼€å‘å†…å®¹ â³
```
sql_database/
â”œâ”€â”€ services/                  # ä¸šåŠ¡é€»è¾‘å±‚ï¼ˆå¾…å¼€å‘ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ base_service.py        # åŸºç¡€æœåŠ¡ç±»
â”‚   â”œâ”€â”€ user_service.py        # ç”¨æˆ·ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ role_service.py        # è§’è‰²ä¸šåŠ¡é€»è¾‘
â”‚   â”œâ”€â”€ permission_service.py  # æƒé™ä¸šåŠ¡é€»è¾‘
â”‚   â””â”€â”€ auth_service.py        # è®¤è¯ä¸šåŠ¡é€»è¾‘
â”œâ”€â”€ api/                       # æ¥å£å±‚ï¼ˆå¾…å¼€å‘ï¼‰
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ app.py                 # Flask/FastAPIåº”ç”¨
â”‚   â”œâ”€â”€ controllers/           # æ§åˆ¶å™¨ç›®å½•
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ user_controller.py
â”‚   â”‚   â”œâ”€â”€ role_controller.py
â”‚   â”‚   â”œâ”€â”€ permission_controller.py
â”‚   â”‚   â””â”€â”€ auth_controller.py
â”‚   â”œâ”€â”€ middleware/            # ä¸­é—´ä»¶
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ auth_middleware.py
â”‚   â”‚   â””â”€â”€ cors_middleware.py
â”‚   â””â”€â”€ schemas/               # è¯·æ±‚/å“åº”æ¨¡å¼
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ user_schemas.py
â”‚       â”œâ”€â”€ role_schemas.py
â”‚       â””â”€â”€ permission_schemas.py
â””â”€â”€ config/                    # é…ç½®æ‰©å±•
    â”œâ”€â”€ api_config.py          # APIé…ç½®
    â””â”€â”€ jwt_config.py          # JWTé…ç½®
```

## ğŸ’¡ å…·ä½“å®ç°ç¤ºä¾‹

### ç¤ºä¾‹1ï¼šç”¨æˆ·æœåŠ¡å®ç°
```python
# services/user_service.py
from dao.user_dao import UserDao
from utils.password_utils import PasswordUtils
from models.user import User

class UserService:
    def __init__(self, session):
        self.user_dao = UserDao(session)
        self.password_utils = PasswordUtils()

    def create_user(self, username: str, email: str, password: str):
        # åˆ©ç”¨ç°æœ‰çš„Useræ¨¡å‹éªŒè¯
        user = User(username=username, email=email)
        if not user.validate_email(email):
            raise ValueError("Invalid email format")

        # åˆ©ç”¨ç°æœ‰çš„å¯†ç å·¥å…·
        password_hash = self.password_utils.hash_password(password)
        user.password_hash = password_hash

        # åˆ©ç”¨ç°æœ‰çš„DAOæ–¹æ³•
        return self.user_dao.create(user)

    def authenticate_user(self, username: str, password: str):
        # åˆ©ç”¨ç°æœ‰çš„æŸ¥è¯¢æ–¹æ³•
        user = self.user_dao.find_by_username(username)
        if not user or not user.is_active():
            return None

        # åˆ©ç”¨ç°æœ‰çš„å¯†ç éªŒè¯
        if self.password_utils.verify_password(password, user.password_hash):
            return user
        return None
```

### ç¤ºä¾‹2ï¼šFastAPIæ§åˆ¶å™¨å®ç°
```python
# api/controllers/user_controller.py
from fastapi import APIRouter, Depends, HTTPException
from pydantic import BaseModel
from services.user_service import UserService

class UserCreateRequest(BaseModel):
    username: str
    email: str
    password: str

class UserResponse(BaseModel):
    id: int
    username: str
    email: str
    status: int
    created_at: datetime

router = APIRouter(prefix="/api/users", tags=["users"])

@router.post("/", response_model=UserResponse)
async def create_user(user_data: UserCreateRequest,
                     user_service: UserService = Depends()):
    try:
        user = user_service.create_user(
            user_data.username,
            user_data.email,
            user_data.password
        )
        return UserResponse.from_orm(user)
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
```

### ç¤ºä¾‹3ï¼šJWTè®¤è¯ä¸­é—´ä»¶
```python
# api/middleware/auth_middleware.py
from fastapi import Depends, HTTPException, status
from fastapi.security import HTTPBearer
from jose import JWTError, jwt
from services.auth_service import AuthService

security = HTTPBearer()

async def get_current_user(token: str = Depends(security),
                          auth_service: AuthService = Depends()):
    try:
        payload = jwt.decode(token.credentials, SECRET_KEY, algorithms=[ALGORITHM])
        username: str = payload.get("sub")
        if username is None:
            raise HTTPException(status_code=401, detail="Invalid token")

        # åˆ©ç”¨ç°æœ‰çš„ç”¨æˆ·æŸ¥è¯¢
        user = auth_service.get_user_by_username(username)
        if user is None:
            raise HTTPException(status_code=401, detail="User not found")
        return user
    except JWTError:
        raise HTTPException(status_code=401, detail="Invalid token")
```

## ğŸ¯ å¼€å‘ä¼˜åŠ¿åˆ†æ

### åŸºäºç°æœ‰åŸºç¡€çš„ä¼˜åŠ¿
1. **å®Œæ•´çš„æ•°æ®å±‚**ï¼š5ä¸ªæ¨¡å‹ç±»ï¼Œ92ä¸ªæ–¹æ³•ï¼Œå…¨é¢è¦†ç›–RBACéœ€æ±‚
2. **æˆç†Ÿçš„DAOå±‚**ï¼š13-15ä¸ªä¸“ç”¨æ–¹æ³•ï¼Œç»è¿‡å…¨é¢æµ‹è¯•
3. **å®‰å…¨å·¥å…·**ï¼šbcryptå¯†ç åŠ å¯†ï¼Œå®‰å…¨æ€§ä¿éšœ
4. **æµ‹è¯•æ¡†æ¶**ï¼špytesté…ç½®å®Œæ•´ï¼Œå¯ç›´æ¥æ‰©å±•APIæµ‹è¯•
5. **å·¥å…·æ”¯æŒ**ï¼šæ—¥å¿—ã€é…ç½®ã€æ•°æ®ç”Ÿæˆç­‰å·¥å…·é½å…¨

### å¼€å‘æ•ˆç‡æå‡
- **å‡å°‘50%å¼€å‘æ—¶é—´**ï¼šæ— éœ€é‡æ–°è®¾è®¡æ•°æ®å±‚
- **é™ä½80%è°ƒè¯•æˆæœ¬**ï¼šåŸºç¡€å±‚å·²ç»è¿‡å……åˆ†æµ‹è¯•
- **æé«˜ä»£ç è´¨é‡**ï¼šåŸºäºæˆç†Ÿçš„æ¶æ„å’Œæ¨¡å¼

---

**é¡¹ç›®çŠ¶æ€**ï¼šåŸºäºå®Œæ•´ORMå±‚ï¼Œå‡†å¤‡é«˜æ•ˆå¼€å‘ä¸šåŠ¡é€»è¾‘å±‚å’Œæ¥å£å±‚
**æ ¸å¿ƒä¼˜åŠ¿**ï¼šæ‹¥æœ‰ç»è¿‡å…¨é¢æµ‹è¯•çš„æ•°æ®è®¿é—®åŸºç¡€ï¼Œå¯ä¸“æ³¨äºä¸šåŠ¡é€»è¾‘å®ç°
**ä¸‹ä¸€æ­¥**ï¼šåˆ›å»ºservicesç›®å½•ï¼Œå¼€å§‹UserServiceå®ç°
